name: Build Guard

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  validate:
    name: Validate Docker & Build Setup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check docker-compose version key
        run: |
          if grep -q "^version:" docker-compose.yml; then
            echo "⚠️ Veraltetes 'version:' Feld in docker-compose.yml gefunden – bitte entfernen!"
            exit 1
          fi

      - name: Check for .dockerignore
        run: |
          if [ ! -f .dockerignore ]; then
            echo "❌ .dockerignore fehlt – bitte hinzufügen!"
            exit 1
          fi

      - name: Dry-run build all services
        run: |
          docker compose convert > /dev/null || (echo "❌ docker-compose.yml ungültig!" && exit 1)
          docker compose build --dry-run || (echo "❌ Build-Fehler!" && exit 1)
        env:
          COMPOSE_DRY_RUN: true
