{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "doc-webhook",
        "options": {}
      },
      "name": "Document Upload Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        1568,
        432
      ],
      "webhookId": "doc-webhook",
      "id": "6e554638-09f0-42ab-b08b-a886a546c201"
    },
    {
      "parameters": {
        "command": "find /data -type f -mmin -1 -name '*.pdf' -o -name '*.txt' -o -name '*.jpg' -o -name '*.png' | head -10"
      },
      "name": "Find New Files",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        1568,
        624
      ],
      "id": "3e00bd50-cc5d-4a23-b6c8-4fe55578338d",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "functionCode": "// Process file list and create tasks\nconst items = [];\nconst stdout = $input.all()[0].json.stdout;\n\nif (stdout && stdout.trim()) {\n  const files = stdout.trim().split('\\n').filter(f => f);\n  \n  for (const filePath of files) {\n    const fileName = filePath.split('/').pop();\n    const fileExt = fileName.split('.').pop().toLowerCase();\n    \n    // Determine task type\n    let taskType = 'index';\n    if (['pdf', 'png', 'jpg', 'jpeg', 'tiff', 'tif'].includes(fileExt)) {\n      taskType = 'ocr';\n    } else if (['txt', 'md', 'csv'].includes(fileExt)) {\n      taskType = 'text';\n    }\n    \n    // Create task\n    const task = {\n      task_id: `n8n_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      file_path: filePath,\n      file_name: fileName,\n      task_type: taskType,\n      source: 'n8n_file_watcher',\n      priority: 5,\n      created_at: new Date().toISOString()\n    };\n    \n    items.push({json: task});\n  }\n}\n\nreturn items.length > 0 ? items : [{json: {message: 'No new files found'}}];"
      },
      "name": "Create Tasks from Files",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1776,
        624
      ],
      "id": "5ea0821f-d973-4ddc-bad3-eb8b27e6b854",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "filePath": "={{ $json.file_path.trim() }}"
      },
      "name": "Read File Binary",
      "type": "n8n-nodes-base.readBinaryFile",
      "typeVersion": 1,
      "position": [
        1968,
        624
      ],
      "id": "f5e88fb1-d1d5-448e-901f-0534e9be44ad",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "functionCode": "// Convert binary to base64 and enhance task\nconst items = [];\n\nfor (const item of $input.all()) {\n  const task = item.json;\n  \n  if (item.binary && item.binary.data) {\n    // Add base64 content to task\n    task.file_content = item.binary.data.data;\n    task.mime_type = item.binary.data.mimeType || 'application/octet-stream';\n  }\n  \n  items.push({json: task});\n}\n\nreturn items;"
      },
      "name": "Add Base64 Content",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        2176,
        624
      ],
      "id": "746ac862-8f5a-4c7d-b1f0-4dc5ede83365",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "=processing_queue",
        "messageData": "={{JSON.stringify($json)}}"
      },
      "name": "Push to Redis Queue",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2368,
        528
      ],
      "id": "20c5922a-e9a7-4e1e-b919-3c86f96d2af7",
      "credentials": {
        "redis": {
          "id": "90xXjCwAdBRlbI1G",
          "name": "Redis account 3"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "functionCode": "// Process webhook uploads\nconst items = [];\n\nfor (const item of $input.all()) {\n  if (item.binary && item.binary.data) {\n    const binaryData = item.binary.data;\n    \n    const task = {\n      task_id: `webhook_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      file_name: binaryData.fileName || 'upload.bin',\n      file_content: binaryData.data,\n      mime_type: binaryData.mimeType || 'application/octet-stream',\n      task_type: determineTaskType(binaryData.fileName, binaryData.mimeType),\n      source: 'webhook_upload',\n      priority: 5,\n      created_at: new Date().toISOString()\n    };\n    \n    items.push({json: task});\n  } else if (item.json.event === 'file_added' && item.json.file_path) {\n    // Legacy format support\n    const task = {\n      task_id: `legacy_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      file_path: item.json.file_path,\n      task_type: 'ocr',\n      source: item.json.source || 'webhook',\n      priority: 5,\n      created_at: new Date().toISOString()\n    };\n    \n    items.push({json: task});\n  }\n}\n\nfunction determineTaskType(fileName, mimeType) {\n  const ext = (fileName || '').toLowerCase().split('.').pop();\n  \n  if (['pdf', 'png', 'jpg', 'jpeg', 'tiff', 'tif'].includes(ext) || \n      (mimeType && mimeType.includes('image'))) {\n    return 'ocr';\n  } else if (['txt', 'md', 'csv'].includes(ext) || \n             (mimeType && mimeType.includes('text'))) {\n    return 'text';\n  }\n  \n  return 'index';\n}\n\nreturn items;"
      },
      "name": "Process Webhook Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1776,
        432
      ],
      "id": "d5466317-5716-41ab-afa1-51fd052c8e38",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "message",
              "value": "Document queued for processing"
            },
            {
              "name": "task_id",
              "value": "={{$json.task_id}}"
            },
            {
              "name": "queue_length",
              "value": "={{$json.queue_length || 'unknown'}}"
            }
          ]
        },
        "options": {}
      },
      "name": "Success Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        2576,
        528
      ],
      "id": "4840786b-df6c-4113-8dff-925397ad06ba",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds"
            }
          ]
        }
      },
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        1376,
        624
      ],
      "id": "ae74348c-d030-4b9b-b4a5-01bfae63c7b0"
    }
  ],
  "pinData": {},
  "connections": {
    "Document Upload Webhook": {
      "main": [
        [
          {
            "node": "Process Webhook Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Find New Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find New Files": {
      "main": [
        [
          {
            "node": "Create Tasks from Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Tasks from Files": {
      "main": [
        [
          {
            "node": "Read File Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read File Binary": {
      "main": [
        [
          {
            "node": "Add Base64 Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Base64 Content": {
      "main": [
        [
          {
            "node": "Push to Redis Queue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Webhook Data": {
      "main": [
        [
          {
            "node": "Push to Redis Queue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push to Redis Queue": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "8deb2fec-4a5a-4eb5-9f36-8c7c3958dae6",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9864951ea4472b9d0ea716c66bb2527efb446aa6309ab9f74077ab1db432402b"
  },
  "id": "LVShTSoyja7c2ZtT",
  "tags": []
}
}
