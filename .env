# === DATABASE ===
POSTGRES_USER=docintell
POSTGRES_PASSWORD=docintell123
POSTGRES_DB=document_intelligence

# === REDIS ===
REDIS_URL=redis://redis:6379
REDIS_TTL=3600

# === PATHS ===
DATA_PATH=./data
INDEX_PATH=./indices
LOG_PATH=./logs

# === API SETTINGS ===
API_HOST=0.0.0.0
API_PORT=8001
DEBUG=false

# === CORS ===
CORS_ALLOW_ORIGIN=http://localhost:8080,http://localhost:5678
CORS_ALLOW_CREDENTIALS=false
CORS_ALLOW_METHODS=GET,POST,PUT,DELETE
CORS_ALLOW_HEADERS=*

# === N8N ===
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=changeme
N8N_WEBHOOK_URL=http://n8n:5678/webhook
N8N_RUNNERS_ENABLED=true

# === OLLAMA ===
OLLAMA_BASE_URL=http://ollama:11434
OLLAMA_MODEL=mistral
OLLAMA_TIMEOUT=120

# === OCR ===
TESSERACT_LANG=deu+eng
OCR_ENGINE=tesseract
OCR_DPI=300

# === PRIVACY ===
ENABLE_PII_REMOVAL=true
ANONYMIZE_METADATA=true

# === SEARCH ===
MIN_RELEVANCE_SCORE=0.3
MAX_SEARCH_RESULTS=50
SEMANTIC_SEARCH_ENABLED=true
CACHE_ENABLED=true
CACHE_TTL=3600

# === LEARNING ===
ENABLE_LEARNING=true
LEARNING_UPDATE_INTERVAL=300
LEARNING_THRESHOLD=0.3

# === PERFORMANCE ===
MAX_WORKERS=4
BATCH_SIZE=10

# === FIX FOR WARNINGS ===
USER_AGENT=DocumentIntelligenceSystem/1.0
CHROMA_TELEMETRY=false
ANONYMIZED_TELEMETRY=false
LANGCHAIN_VERBOSE=false
LANGCHAIN_TRACING=false
TORCH_VERSION=2.1.0
PYTORCH_ENABLE_MPS_FALLBACK=1

# ===================================
# KOMPLETTES START-SCRIPT
# ===================================

#!/bin/bash
# start_fixed.sh - Garantiert funktionierende Startsequenz

echo "🔧 Starting Document Intelligence System (FIXED VERSION)"

# 1. Stoppe alles und räume auf
echo "Stopping old containers..."
docker compose down -v
docker system prune -f

# 2. Erstelle Verzeichnisse
echo "Creating directories..."
mkdir -p data indices/{json,markdown} logs n8n/workflows

# 3. Erstelle .env falls nicht vorhanden
if [ ! -f .env ]; then
    echo "Creating .env file..."
    cat > .env << 'EOF'
POSTGRES_PASSWORD=docintell123
REDIS_URL=redis://redis:6379
USER_AGENT=DocumentIntelligenceSystem/1.0
CORS_ALLOW_ORIGIN=http://localhost:8080,http://localhost:5678
N8N_RUNNERS_ENABLED=true
EOF
fi

# 4. Baue ALLE Container neu
echo "Building containers (this may take a while)..."
docker compose build --no-cache

# 5. Starte Services in korrekter Reihenfolge
echo "Starting core services..."
docker compose up -d redis postgres
echo "Waiting for databases to initialize..."
sleep 15

echo "Starting agents..."
docker compose up -d watchdog ocr_agent indexer
sleep 10

echo "Starting API services..."
docker compose up -d search_api n8n ollama
sleep 10

echo "Starting web interfaces..."
docker compose up -d open-webui

# 6. Zeige Status
echo ""
echo "=== SERVICE STATUS ==="
docker compose ps

# 7. Warte und zeige Logs
echo ""
echo "=== CHECKING SERVICES ==="
sleep 5

# Prüfe Redis
if docker compose exec -T redis redis-cli ping | grep -q PONG; then
    echo "✅ Redis is working"
else
    echo "❌ Redis failed"
fi

# Prüfe PostgreSQL
if docker compose exec -T postgres pg_isready -U docintell | grep -q "accepting connections"; then
    echo "✅ PostgreSQL is working"
else
    echo "❌ PostgreSQL failed"
fi

# Prüfe Services
for service in watchdog ocr_agent indexer search_api n8n; do
    if docker compose ps | grep -q "$service.*Up"; then
        echo "✅ $service is running"
    else
        echo "❌ $service failed"
    fi
done

echo ""
echo "=== ACCESS POINTS ==="
echo "📊 N8N Workflows: http://localhost:5678 (admin/changeme)"
echo "🔍 Search UI: http://localhost:8080"
echo "📚 API Docs: http://localhost:8001/docs"
echo ""
echo "To view logs: docker compose logs -f"
echo "To stop: docker compose down"

# ===================================
# WINDOWS BATCH VERSION
# ===================================

@echo off
REM start_fixed.bat - Windows Version

echo Starting Document Intelligence System (FIXED VERSION)

REM 1. Stop and cleanup
echo Stopping old containers...
docker compose down -v

REM 2. Create directories
echo Creating directories...
mkdir data 2>nul
mkdir indices\json 2>nul
mkdir indices\markdown 2>nul
mkdir logs 2>nul
mkdir n8n\workflows 2>nul

REM 3. Build containers
echo Building containers...
docker compose build --no-cache

REM 4. Start in order
echo Starting core services...
docker compose up -d redis postgres
timeout /t 15 /nobreak >nul

echo Starting agents...
docker compose up -d watchdog ocr_agent indexer
timeout /t 10 /nobreak >nul

echo Starting APIs...
docker compose up -d search_api n8n ollama
timeout /t 10 /nobreak >nul

echo Starting web interfaces...
docker compose up -d open-webui

REM 5. Show status
echo.
echo === SERVICE STATUS ===
docker compose ps

echo.
echo === ACCESS POINTS ===
echo N8N: http://localhost:5678 (admin/changeme)
echo Search: http://localhost:8080
echo API: http://localhost:8001/docs
echo.
echo View logs: docker compose logs -f
pause
